---

# FACTS GATHERING

- name: "[Install {{ amd_apm_release.release }}] Set Tools facts"
  ansible.builtin.set_fact:
    amd_apm_tools_installer_bin: "{{ amd_apm_packages[amd_apm_release.release]['tools']['installer'][amd_apm_release.update_level]['bin'] }}"
    amd_apm_tools_installer_checksum: "{{ amd_apm_packages[amd_apm_release.release]['tools']['installer'][amd_apm_release.update_level]['checksum_md5'] }}"
    amd_apm_tools_prerequisites: "{{ amd_apm_packages[amd_apm_release.release]['tools']['prerequisites'] }}"

- name: "[Install {{ amd_apm_release.release }}] Set Tools installer path fact"
  ansible.builtin.set_fact:
    amd_apm_tools_installer: "{{ amd_apm_tools_download_path }}/{{ amd_apm_release.release }}/{{ amd_apm_tools_installer_bin }}"

- name: "[Install {{ amd_apm_release.release }}] Assert that user_email and user_password are set for AMD installer tool"
  assert:
    that:
      - amd_apm_user_email is not none
      - amd_apm_user_email is string
      - amd_apm_user_email is match("^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$")
      - amd_apm_user_password is not none
      - amd_apm_user_password is string
    fail_msg: "Either or both `amd_apm_user_email` and `amd_apm_user_password` have not been set. 'amd_apm_user_email' must be a valid email address (e.g., user@example.com)."


# PREPARE INSTALLER

- name: "[Install {{ amd_apm_release.release }}] Gather stats about Tools installer"
  stat:
    path: "{{ amd_apm_tools_installer }}"
    checksum_algorithm: md5
    get_checksum: True
  register: amd_apm_tools_installer_stats

- name: "[Install {{ amd_apm_release.release }}] Assert that the installer is available"
  assert:
    that:
      - amd_apm_tools_installer_stats.stat.exists
    fail_msg: "[ERROR] Can't find the AMD tools installer: {{ amd_apm_tools_installer }}. Please download it from https://www.xilinx.com/support/download/index.html/content/xilinx/en/downloadNav/vitis.html"

- name: "[Install {{ amd_apm_release.release }}] Assert that the checksum of the installer is correct"
  assert:
    that:
      - amd_apm_tools_installer_stats.stat.checksum == amd_apm_tools_installer_checksum
    fail_msg: "[ERROR] Checksum of the installer is incorrect: {{ amd_apm_tools_installer }}. The file might have been tampered with. Please download the correct version from https://www.xilinx.com/support/download/index.html/content/xilinx/en/downloadNav/vitis.html"

- name: "[Install {{ amd_apm_release.release }}] Set permissions of installer to allow execution"
  file:
    path: "{{ amd_apm_tools_installer }}"
    mode: 755


# AMD AUTHENTICATION

- name: "[Install {{ amd_apm_release.release }}] Check AMD authentication key file stats"
  stat:
    path: "/root/.Xilinx/wi_authentication_key"
  register: amd_apm_installer_auth_file_stats

- name: "[Install {{ amd_apm_release.release }}] Set auth_valid default to whether the auth file exists"
  set_fact:
    amd_apm_installer_auth_valid: "{{ amd_apm_installer_auth_file_stats.stat.exists and amd_apm_installer_auth_file_stats.stat.mode == '0400' }}"

- name: "[Install {{ amd_apm_release.release }}] Read and validate authentication data"
  when: amd_apm_installer_auth_valid
  block:
    - name: "[Install {{ amd_apm_release.release }}] Get authentication file contents"
      slurp:
        src: /root/.Xilinx/wi_authentication_key
      register: amd_apm_installer_auth_data

    - name: "[Install {{ amd_apm_release.release }}] Parse authentication file and check whether it is valid for specified user"
      set_fact:
        amd_apm_installer_auth_valid: "{{
          (amd_apm_installer_auth_data['content'] | b64decode | from_json)['username'] == amd_apm_user_email
          and
          ((((amd_apm_installer_auth_data['content'] | b64decode | from_json)['expiration'] | replace('\\/', '/') | to_datetime('%m/%d/%Y %I:%M %p')) - (ansible_date_time.iso8601 | to_datetime('%Y-%m-%dT%H:%M:%SZ'))).total_seconds() > 3600)
          }}"
  rescue:
    - name: "[Install {{ amd_apm_release.release }}] Handle AMD authentication file parsing errors"
      set_fact:
        amd_apm_installer_auth_valid: false

- name: "[Install {{ amd_apm_release.release }}] Generate AMD Auth token"
  expect:
    command: "{{ amd_apm_tools_installer }} --nox11 -- --batch AuthTokenGen"
    responses:
      "E-mail Address:":
        - "{{ amd_apm_user_email }}"
      "Password:":
        - "{{ amd_apm_user_password }}"
  when: not amd_apm_installer_auth_valid


# INSTALL

- name: "[Install {{ amd_apm_release.release }}] Install prerequisite packages"
  package:
    name: amd_apm_tools_prerequisites
    state: present

- name: "[Install {{ amd_apm_release.release }}] Ensure Vitis install directory exists"
  ansible.builtin.file:
    path: "{{ amd_apm_tools_install_path }}"
    state: directory

- name: "[Install {{ amd_apm_release.release }}] Ensure /root/.Xilinx directory exists"
  ansible.builtin.file:
    path: /root/.Xilinx
    state: directory

# TODO: add configs to a version directory: eg. /root/.Xilinx/2024.2/install_config.txt
- name: "[Install {{ amd_apm_release.release }}] Generate AMD tools configuration file"
  expect:
    command: "{{ amd_apm_tools_installer }} --nox11 -- --batch ConfigGen --location {{ amd_apm_tools_install_path }} --product '{% if amd_apm_release.vivado_only %}Vivado{% else %}Vitis{% endif %}'"
    responses:
      "Please choose: ":
        - "1"

# TODO: move config editing to seperate tasks file and reuse with other install tasks
- name: "[Install {{ amd_apm_release.release }}] Disable shortcut creation"
  lineinfile:
    path: /root/.Xilinx/install_config.txt
    regexp: "{{ item.regexp }}"
    line: "{{ item.line  }}"
  loop:
    - { regexp: '^CreateProgramGroupShortcuts=', line: 'CreateProgramGroupShortcuts=0' }
    - { regexp: '^CreateShortcutsForAllUsers=', line: 'CreateShortcutsForAllUsers=0' }
    - { regexp: '^CreateDesktopShortcuts=', line: 'CreateDesktopShortcuts=0' }
    - { regexp: '^CreateFileAssociation=', line: 'CreateFileAssociation=0' }

# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
# SELECTING DEVICES TO INSTALL
# TODO: Make this more specific instead of installing all devices: allow for a selection

- name: Read the file content
  ansible.builtin.slurp:
    src: /root/.Xilinx/install_config.txt
  register: file_content

- name: Extract the Modules= line
  set_fact:
    modules_line: "{{ (file_content.content | b64decode).splitlines() | select('match', '^Modules=') | list | first }}"

- name: Extract module entries
  set_fact:
    module_entries: "{{ modules_line.split('=', 1)[1].split(',') }}"

- name: Normalize module entries to end with :1
  set_fact:
    normalized_modules: "{{ module_entries | map('regex_replace', ':(\\d+)$', ':1') | list }}"

- name: Rebuild the line
  set_fact:
    new_modules_line: "Modules={{ normalized_modules | join(',') }}"

- name: Replace the Modules= line in the file
  ansible.builtin.lineinfile:
    path: /root/.Xilinx/install_config.txt
    regexp: '^Modules='
    line: "{{ new_modules_line }}"

# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

- name: "[Install {{ amd_apm_release.release }}] Install Tools (this usually takes about 2 hours, but can take up to 6 hours...)"
  command: "{{ amd_apm_tools_installer }} --nox11 -- --batch Install --config /root/.Xilinx/install_config.txt --agree XilinxEULA,3rdPartyEULA"
  vars:
    # wait up to 6 hours
    ansible_command_timout: 21600
    ansible_ssh_timout: 21600

