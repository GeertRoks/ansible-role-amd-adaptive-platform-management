---

- name: "[Install {{ amd_apm_release }}] Set Vitis Core facts"
  ansible.builtin.set_fact:
    amd_apm_tools_download_url: "{{ amd_apm_packages[ansible_distribution][ansible_distribution_version][amd_apm_release]['tools']['url'] }}"
    amd_apm_tools_package: "{{ amd_apm_packages[ansible_distribution][ansible_distribution_version][amd_apm_release]['tools']['package'] }}"
    amd_apm_tools_archive: "{{ amd_apm_packages[ansible_distribution][ansible_distribution_version][amd_apm_release]['tools']['package'] }}.tar"
    amd_apm_tools_checksum: "{{ amd_apm_packages[ansible_distribution][ansible_distribution_version][amd_apm_release]['tools']['checksum'] }}"

- name: "[Install {{ amd_apm_release }}] Check if the tools archive has already been downloaded"
  stat:
    path: "{{ amd_apm_tools_download_path }}/{{ amd_apm_tools_archive }}"
  register: amd_apm_tools_archive_stats

- name: "[Install {{ amd_apm_release }}] Check if the tools archive has already been extracted"
  stat:
    path: "{{ amd_apm_tools_extraction_path }}"
  register: amd_apm_tools_extraction_stats

# DOWNLOAD
# runs when:
#   - tools archive has not yet been downloaded
#   and
#   - tools archive has not yet been archived
- when:
    - not amd_apm_tools_archive_stats.stat.exists
    - not amd_apm_tools_extraction_stats.stat.exists
  block:
    - name: "[Install {{ amd_apm_release }}] Ensure Vitis download directory exists"
      ansible.builtin.file:
        path: "{{ amd_apm_tools_download_path }}"
        state: directory

    #TODO: download protected behind amd sign in and html form, need to handle this programmatically
    #TODO: replace the download task with an assert that check wheter it is there or not.
    - name: "[Install {{ amd_apm_release }}] Download Vitis core package (100+ GB file, may take a while...)"
      ansible.builtin.get_url:
        url: "{{ amd_apm_tools_download_url }}{{ amd_apm_tools_archive }}"
        dest: "{{ amd_apm_tools_download_path }}"
        checksum: "{{ amd_apm_tools_checksum }}"

- debug:
    msg: "Download has been skipped, because either tools have already been downloaded or extracted. If you want to redo the download, make sure that both the archive at location `{{ amd_apm_tools_download_path }}/{{ amd_apm_tools_archive }}`, and extracted archive at location `{{ amd_apm_tools_extraction_path }}`, are deleted."
  when: amd_apm_tools_archive_stats.stat.exists or amd_apm_tools_extraction_stats.stat.exists

  #TODO: implement to have the zip be extracted locally and then send to the remote

# EXTRACTION
# runs when:
#   - tools archive has been downloaded to the correct location
#   and
#   - tools archive has not been extracted
- when:
    - amd_apm_tools_archive_stats.stat.exists
    - not amd_apm_tools_extraction_stats.stat.exists
  block:
  - name: "[Install {{ amd_apm_release }}] Ensure Vitis archive extraction directory exists"
    ansible.builtin.file:
      path: "{{ amd_apm_tools_download_path }}/{{ amd_apm_tools_package }}"
      state: directory

  - name: "[Install {{ amd_apm_release }}] Extract Vitis core archive (100+ GB file, may take a while...)"
    unarchive:
      src: "{{ amd_apm_tools_download_path }}/{{ amd_apm_tools_archive }}"
      dest: "{{ amd_apm_tools_extraction_path }}"
      remote_src: yes
      extra_opts: "--no-same-owner"

- debug:
    msg: "Extraction has been skipped, because the tools have either already been extracted. If you want to redo the extraction, make sure that the archive at location `{{ amd_apm_tools_download_path }}/{{ amd_apm_tools_archive }}` exists, and the extracted archive at location `{{ amd_apm_tools_extraction_path }}` is deleted."
  when: not amd_apm_tools_archive_stats.stat.exists or amd_apm_tools_extraction_stats.stat.exists
- name: Ensure Vitis install directory exists
  ansible.builtin.file:
    path: "{{ amd_apm_tools_install_path }}"
    state: directory

# INSTALL


- name: Ensure /root/.Xilinx directory exists
  ansible.builtin.file:
    path: /root/.Xilinx
    state: directory

#TODO: investigate if installation can be done by just using the --edition flag
# https://docs.amd.com/r/en-US/ug973-vivado-release-notes-install-license/Batch-Mode-Installation-Flow

# full Vitis install
- name:
  template:
    src: files/install_config_vitis.txt.j2
    dest: /root/.Xilinx/install_config.txt
    mode: 0644
  when: amd_apm_tools_install_vitis

# Vivado only install
- name:
  template:
    src: files/install_config_vivado.txt.j2 
    dest: /root/.Xilinx/install_config.txt
    mode: 0644
  when: not amd_apm_tools_install_vitis

#TODO: takes a lot of time: see if it can be shortend
- name: Install Vitis core
  shell: "./xsetup --agree XilinxEULA,3rdPartyEULA --batch Install --config /root/.Xilinx/install_config.txt"
  args:
    chdir: "{{ amd_apm_tools_extraction_path }}"
  async: 6000
  poll: 20
  when: false


- name: "[Install {{ amd_apm_release }}] Set bash environment"
  when:
    - amd_apm_releases | length == 1
    - amd_apm_tools_set_bash_environment_variables
  block:
    #Vivado is always installed
    #Vitis_HLS also comes with Vivado
    - name: Add Vivado source scripts to general bashrc
      lineinfile:
        path: /etc/bash.bashrc
        insertbefore: '^source\s+/opt/xilinx/xrt/setup.sh'
        line: "source {{ amd_apm_tools_install_path }}/{{ item }}/{{ amd_apm_release }}/settings64.sh"
      loop:
        - "Vivado"
        - "Vitis_HLS"

    # Vitis is only installed, when install_vitis == true
    # Model Composer comes with Vitis
    - name: Add Vitis source scripts to general bashrc
      lineinfile:
        path: /etc/bash.bashrc
        insertbefore: '^source\s+/opt/xilinx/xrt/setup.sh'
        line: "source {{ amd_apm_tools_install_path }}/{{ item }}/{{ amd_apm_release }}/settings64.sh"
        state: "{{ 'present' if amd_apm_tools_install_vitis|bool else 'absent' }}"
      loop:
        - "Vitis"
        - "Model_Composer"

    - name: Add Vitis Model Composer to system-wide PATH
      lineinfile:
        path: /etc/bash.bashrc
        line: 'export PATH={{ amd_apm_tools_install_path }}/Model_Composer/{{ amd_apm_release }}/bin:$PATH'
        state: "{{ 'absent' if amd_apm_tools_install_vivado_only|bool else 'present' }}"

- name: "INFO: set_bash_environment_variables is set to true is ignored"
  debug:
      msg: "amd_apm_tools_set_bash_environment_variables is set to true, but this is ignored as there are more than one releases defined in the amd_apm_releases variable. Only one version can be actived at a time. Use a tool like `module` or `hdev` to manage multiple versions."
    when:
      - amd_apm_releases | length gt 1
      - amd_apm_tools_set_bash_environment_variables
